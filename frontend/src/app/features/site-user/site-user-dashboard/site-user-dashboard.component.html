<div class="dashboard-container">
  <!-- Header -->
  <div class="dashboard-header">
    <div class="header-left-section">
      <div>
        <h1>Site User Dashboard</h1>
        <p *ngIf="currentUser">Welcome back, {{ currentUser.full_name }}!</p>
      </div>
    </div>
    <div class="header-stats">
      <!-- Circular Progress -->
      <div class="stat-item progress-circular">
        <div class="circular-progress-container">
          <svg class="circular-progress-svg" viewBox="0 0 100 100">
            <circle class="progress-background" cx="50" cy="50" r="45"></circle>
            <circle class="progress-fill" cx="50" cy="50" r="45"
                    [style.stroke-dashoffset]="getProgressDashOffset()"></circle>
          </svg>
          <div class="progress-label">
            <span class="progress-percentage">{{ getOverallCompletionPercentage() }}%</span>
            <span class="progress-text">Complete</span>
          </div>
        </div>
      </div>

      <!-- Due Today Counter -->
      <div class="stat-item stat-card due-today">
        <mat-icon class="stat-icon">schedule</mat-icon>
        <div class="stat-content">
          <div class="stat-number">{{ openTasks.length }}</div>
          <div class="stat-label">Due Today</div>
        </div>
      </div>

      <!-- Missed Counter -->
      <div class="stat-item stat-card missed">
        <mat-icon class="stat-icon">error</mat-icon>
        <div class="stat-content">
          <div class="stat-number">{{ missedTasks.length }}</div>
          <div class="stat-label">Missed</div>
        </div>
      </div>

      <!-- Completed Counter -->
      <div class="stat-item stat-card completed">
        <mat-icon class="stat-icon">check_circle</mat-icon>
        <div class="stat-content">
          <div class="stat-number">{{ completedTasks.length }}</div>
          <div class="stat-label">Completed</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="loading-container">
    <mat-spinner></mat-spinner>
    <p>Loading your checklists...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !loading" class="error-container">
    <mat-icon>error</mat-icon>
    <p>{{ error }}</p>
  </div>

  <!-- Main Content -->
  <div *ngIf="!loading && !error" class="dashboard-content">

    <!-- Open Checklists Section -->
    <section class="task-section">
      <h2>
        <mat-icon>assignment</mat-icon>
        Open Checklists ({{ openTasks.length }})
      </h2>

      <div *ngIf="openTasks.length === 0" class="empty-state">
        <mat-icon>check_circle</mat-icon>
        <p>No open checklists. Great job!</p>
      </div>

      <div class="task-grid">
        <mat-card *ngFor="let checklist of openTasks" class="task-card open">
          <div class="card-compact-header" (click)="toggleChecklist(checklist.id)">
            <div class="header-left">
              <span class="items-count">{{ checklist.completedItems }}/{{ checklist.totalItems }}</span>
              <h3 class="checklist-title-compact">{{ checklist.categoryName }}</h3>
            </div>
            <div class="header-right">
              <span class="due-date-compact">
                <mat-icon>schedule</mat-icon>
                {{ formatDueDate(checklist.dueDate) }}
              </span>
              <mat-icon class="expand-icon">{{ expandedChecklists.has(checklist.id) ? 'expand_less' : 'expand_more' }}</mat-icon>
            </div>
          </div>

          <div class="progress-bar-compact">
            <mat-progress-bar mode="determinate" [value]="checklist.completionPercentage"></mat-progress-bar>
          </div>

          <div class="checklist-items" *ngIf="expandedChecklists.has(checklist.id)">
            <div class="items-loading" *ngIf="loadingItems.has(checklist.id)">
              <mat-spinner diameter="30"></mat-spinner>
              <span>Loading checklist items...</span>
            </div>
            <div class="items-list" *ngIf="!loadingItems.has(checklist.id) && checklistItems.get(checklist.id)">
              <div class="checklist-item" *ngFor="let item of checklistItems.get(checklist.id)">
                <mat-checkbox
                  [checked]="item.is_completed"
                  (change)="toggleItem(checklist.id, item)">
                  {{ item.item_name }}
                </mat-checkbox>
              </div>
            </div>
          </div>
        </mat-card>
      </div>
    </section>

    <!-- Missed Checklists Section -->
    <section class="task-section" *ngIf="missedTasks.length > 0">
      <h2>
        <mat-icon>error</mat-icon>
        Missed Checklists ({{ missedTasks.length }})
      </h2>

      <div class="task-grid">
        <mat-card *ngFor="let checklist of missedTasks" class="task-card missed">
          <div class="card-compact-header" (click)="toggleChecklist(checklist.id)">
            <div class="header-left">
              <span class="items-count overdue-count">{{ checklist.completedItems }}/{{ checklist.totalItems }}</span>
              <h3 class="checklist-title-compact">{{ checklist.categoryName }}</h3>
            </div>
            <div class="header-right">
              <span class="due-date-compact overdue-date">
                <mat-icon>error</mat-icon>
                {{ formatDueDate(checklist.dueDate) }}
              </span>
              <mat-icon class="expand-icon">{{ expandedChecklists.has(checklist.id) ? 'expand_less' : 'expand_more' }}</mat-icon>
            </div>
          </div>

          <div class="progress-bar-compact">
            <mat-progress-bar mode="determinate" [value]="checklist.completionPercentage" color="warn"></mat-progress-bar>
          </div>

          <div class="checklist-items" *ngIf="expandedChecklists.has(checklist.id)">
            <div class="items-loading" *ngIf="loadingItems.has(checklist.id)">
              <mat-spinner diameter="30"></mat-spinner>
              <span>Loading checklist items...</span>
            </div>
            <div class="items-list" *ngIf="!loadingItems.has(checklist.id) && checklistItems.get(checklist.id)">
              <div class="checklist-item" *ngFor="let item of checklistItems.get(checklist.id)">
                <mat-checkbox
                  [checked]="item.is_completed"
                  (change)="toggleItem(checklist.id, item)">
                  {{ item.item_name }}
                </mat-checkbox>
              </div>
            </div>
          </div>
        </mat-card>
      </div>
    </section>

    <!-- Completed Checklists Section -->
    <section class="task-section" *ngIf="completedTasks.length > 0">
      <h2>
        <mat-icon>check_circle</mat-icon>
        Completed Checklists ({{ completedTasks.length }})
      </h2>

      <div class="task-grid">
        <mat-card *ngFor="let checklist of completedTasks" class="task-card completed">
          <div class="card-compact-header" (click)="toggleChecklist(checklist.id)">
            <div class="header-left">
              <span class="items-count completed-count">{{ checklist.completedItems }}/{{ checklist.totalItems }}</span>
              <h3 class="checklist-title-compact">{{ checklist.categoryName }}</h3>
            </div>
            <div class="header-right">
              <span class="due-date-compact completed-date">
                <mat-icon>event_available</mat-icon>
                {{ formatDueDate(checklist.dueDate) }}
              </span>
              <mat-icon class="expand-icon">{{ expandedChecklists.has(checklist.id) ? 'expand_less' : 'expand_more' }}</mat-icon>
            </div>
          </div>

          <div class="progress-bar-compact completed-progress">
            <mat-progress-bar mode="determinate" [value]="checklist.completionPercentage"></mat-progress-bar>
          </div>

          <div class="checklist-items" *ngIf="expandedChecklists.has(checklist.id)">
            <div class="items-loading" *ngIf="loadingItems.has(checklist.id)">
              <mat-spinner diameter="30"></mat-spinner>
              <span>Loading checklist items...</span>
            </div>
            <div class="items-list" *ngIf="!loadingItems.has(checklist.id) && checklistItems.get(checklist.id)">
              <div class="checklist-item" *ngFor="let item of checklistItems.get(checklist.id)">
                <mat-checkbox
                  [checked]="item.is_completed"
                  [disabled]="true">
                  {{ item.item_name }}
                </mat-checkbox>
              </div>
            </div>
          </div>
        </mat-card>
      </div>
    </section>

    <!-- My Open Defects Section -->
    <section class="defects-section">
      <h2>
        <mat-icon>warning</mat-icon>
        My Open Defects ({{ myOpenDefects.length }})
      </h2>

      <div *ngIf="myOpenDefects.length === 0" class="empty-state">
        <mat-icon>check_circle</mat-icon>
        <p>No open defects reported by you.</p>
      </div>

      <div class="defects-list">
        <mat-card *ngFor="let defect of myOpenDefects" class="defect-card">
          <mat-card-header>
            <mat-card-title>{{ defect.title }}</mat-card-title>
            <mat-card-subtitle>
              <span [ngClass]="getSeverityColor(defect.severity)" class="severity-badge">
                {{ defect.severity }}
              </span>
              <span [ngClass]="getDefectStatusColor(defect.status)" class="status-badge">
                {{ defect.status }}
              </span>
            </mat-card-subtitle>
          </mat-card-header>

          <mat-card-content>
            <p>{{ defect.description }}</p>
          </mat-card-content>

          <mat-card-actions>
            <button mat-button color="primary" (click)="viewDefect(defect.id)">
              View Details
            </button>
          </mat-card-actions>
        </mat-card>
      </div>
    </section>

  </div>
</div>
