<div class="task-field-builder">
  <div class="header mb-6">
    <h2 class="text-2xl font-bold text-gray-900 mb-2">Dynamic Form Builder</h2>
    <p class="text-gray-600">Configure custom fields for this task</p>
  </div>

  <div *ngIf="loading" class="loading">
    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
    <p class="text-center mt-4 text-gray-600">Loading fields...</p>
  </div>

  <form [formGroup]="fieldsForm" *ngIf="!loading">
    <div cdkDropList (cdkDropListDropped)="onDrop($event)" class="fields-list">
      <div *ngFor="let field of fields.controls; let i = index"
           [formGroupName]="i"
           cdkDrag
           class="field-item">

        <!-- Drag Handle -->
        <div cdkDragHandle class="drag-handle">
          <span class="text-gray-400">‚ò∞</span>
        </div>

        <!-- Field Content -->
        <div class="field-content">
          <!-- Field Type Icon -->
          <div class="field-icon">
            <span class="text-2xl">{{ getFieldTypeIcon(field.get('field_type')?.value) }}</span>
          </div>

          <!-- Field Configuration -->
          <div class="field-config">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <!-- Field Label -->
              <div class="form-group">
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  Field Label *
                </label>
                <input
                  type="text"
                  formControlName="field_label"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  placeholder="e.g., Temperature (¬∞C)"
                />
              </div>

              <!-- Field Type -->
              <div class="form-group">
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  Field Type *
                </label>
                <select
                  formControlName="field_type"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                >
                  <option *ngFor="let type of fieldTypes" [value]="type.value">
                    {{ type.icon }} {{ type.label }}
                  </option>
                </select>
              </div>
            </div>

            <!-- Dropdown Options (conditional) -->
            <div *ngIf="needsOptions(field.get('field_type')?.value)" class="form-group mt-4">
              <label class="block text-sm font-medium text-gray-700 mb-1">
                Options (comma-separated) *
              </label>
              <input
                type="text"
                [value]="formatOptions(field.get('options')?.value)"
                (input)="field.get('options')?.setValue(parseOptions($any($event.target).value))"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                placeholder="e.g., Excellent, Good, Fair, Poor"
              />
            </div>

            <!-- Required Checkbox -->
            <div class="form-group mt-4">
              <label class="inline-flex items-center">
                <input
                  type="checkbox"
                  formControlName="is_required"
                  class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                />
                <span class="ml-2 text-sm text-gray-700">Required field</span>
              </label>
            </div>
          </div>

          <!-- Delete Button -->
          <div class="field-actions">
            <button
              type="button"
              (click)="removeField(i)"
              class="delete-btn"
              title="Delete field"
            >
              <span class="text-red-600">üóëÔ∏è</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Empty State -->
      <div *ngIf="fields.length === 0" class="empty-state">
        <div class="text-center py-12">
          <span class="text-6xl mb-4 block">üìã</span>
          <h3 class="text-lg font-medium text-gray-900 mb-2">No fields configured</h3>
          <p class="text-gray-600 mb-4">Add custom fields to make this task dynamic</p>
          <button
            type="button"
            (click)="addField()"
            class="btn-primary"
          >
            Add First Field
          </button>
        </div>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="actions mt-6" *ngIf="fields.length > 0">
      <button
        type="button"
        (click)="addField()"
        class="btn-secondary"
      >
        <span class="mr-2">+</span>
        Add Field
      </button>

      <button
        type="button"
        (click)="saveFields()"
        [disabled]="saving || fieldsForm.invalid"
        class="btn-primary ml-4"
      >
        <span *ngIf="!saving">üíæ Save Fields</span>
        <span *ngIf="saving" class="flex items-center">
          <span class="animate-spin mr-2">‚ü≥</span>
          Saving...
        </span>
      </button>
    </div>
  </form>
</div>
