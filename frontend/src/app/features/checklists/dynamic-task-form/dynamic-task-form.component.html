<div class="dynamic-task-form">
  <!-- Loading State -->
  <div *ngIf="loading" class="loading">
    <div class="spinner"></div>
    <p>Loading form...</p>
  </div>

  <!-- Dynamic Form -->
  <form [formGroup]="dynamicForm" (ngSubmit)="onSubmit()" *ngIf="!loading && taskFields.length > 0">
    <div class="form-fields">
      <div *ngFor="let field of taskFields" class="field-wrapper">
        <div class="field-header">
          <label class="field-label">
            {{ field.field_label }}
            <span *ngIf="field.is_required" class="required">*</span>
          </label>
        </div>

        <!-- Number Input -->
        <div *ngIf="field.field_type === TaskFieldType.NUMBER || field.field_type === TaskFieldType.TEMPERATURE">
          <input
            type="number"
            [formControlName]="'field_' + field.id"
            [class.out-of-range]="isOutOfRange(field)"
            class="form-input"
            [placeholder]="'Enter ' + field.field_label.toLowerCase()"
            step="any"
            (input)="onCountChange(field)"
          />
          <div class="field-hint" *ngIf="field.validation_rules">
            {{ getValidationMessage(field) }}
          </div>
          <div class="warning-message" *ngIf="isOutOfRange(field)">
            ‚ö†Ô∏è Value is outside expected range! This may create a defect.
          </div>
        </div>

        <!-- Text Input -->
        <div *ngIf="field.field_type === TaskFieldType.TEXT">
          <input
            type="text"
            [formControlName]="'field_' + field.id"
            class="form-input"
            [placeholder]="'Enter ' + field.field_label.toLowerCase()"
          />
        </div>

        <!-- Yes/No Toggle -->
        <div *ngIf="field.field_type === TaskFieldType.YES_NO" class="yes-no-field">
          <div class="yes-no-buttons">
            <button
              type="button"
              class="yes-no-btn"
              [class.active]="dynamicForm.get('field_' + field.id)?.value === true"
              (click)="dynamicForm.get('field_' + field.id)?.setValue(true)"
            >
              <span class="text-2xl">‚úì</span>
              <span>Yes</span>
            </button>
            <button
              type="button"
              class="yes-no-btn"
              [class.active]="dynamicForm.get('field_' + field.id)?.value === false"
              (click)="dynamicForm.get('field_' + field.id)?.setValue(false)"
            >
              <span class="text-2xl">‚úó</span>
              <span>No</span>
            </button>
          </div>
        </div>

        <!-- Dropdown -->
        <div *ngIf="field.field_type === TaskFieldType.DROPDOWN">
          <select
            [formControlName]="'field_' + field.id"
            class="form-select"
          >
            <option value="">Select an option...</option>
            <option *ngFor="let option of field.options" [value]="option">
              {{ option }}
            </option>
          </select>
        </div>

        <!-- Photo Upload -->
        <div *ngIf="field.field_type === TaskFieldType.PHOTO">
          <div class="photo-upload">
            <input
              type="file"
              accept="image/*"
              [id]="'photo_' + field.id"
              class="photo-input"
              (change)="onPhotoSelected($event, field)"
            />
            <label [for]="'photo_' + field.id" class="photo-btn">
              <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
              </svg>
              <span>Upload Photo</span>
            </label>
            <div *ngIf="dynamicForm.get('field_' + field.id)?.value" class="photo-preview">
              <img [src]="dynamicForm.get('field_' + field.id)?.value" alt="Uploaded photo" class="uploaded-photo" />
            </div>
          </div>
        </div>

        <!-- Repeating Group -->
        <div *ngIf="field.field_type === TaskFieldType.REPEATING_GROUP">
          <div class="repeating-group">
            <div *ngIf="getRepeatingInstances(field.id).length === 0" class="text-gray-500 text-sm italic">
              Enter a count in the field above to generate entries
            </div>

            <div *ngFor="let instance of getRepeatingInstances(field.id); let i = index" class="repeating-instance">
              <div class="instance-header">
                <span class="instance-number">{{ instance.label }}</span>
              </div>

              <div class="instance-fields">
                <div *ngFor="let template of field.validation_rules?.repeat_template" class="instance-field">
                  <!-- Temperature field -->
                  <div *ngIf="template.type === 'temperature' || template.type === 'number'">
                    <label class="instance-field-label">{{ template.label }}</label>
                    <input
                      type="number"
                      [formControlName]="'field_' + field.id + '_' + i + '_' + template.type"
                      class="form-input"
                      step="any"
                      [placeholder]="template.label"
                    />
                  </div>

                  <!-- Photo field -->
                  <div *ngIf="template.type === 'photo'">
                    <label class="instance-field-label">{{ template.label }}</label>
                    <div class="photo-upload">
                      <input
                        type="file"
                        accept="image/*"
                        [id]="'photo_' + field.id + '_' + i"
                        class="photo-input"
                        (change)="onPhotoSelectedRepeating($event, field.id, i, template.type)"
                      />
                      <label [for]="'photo_' + field.id + '_' + i" class="photo-btn-small">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        <span>Photo</span>
                      </label>
                      <div *ngIf="dynamicForm.get('field_' + field.id + '_' + i + '_' + template.type)?.value" class="photo-preview-small">
                        <img [src]="dynamicForm.get('field_' + field.id + '_' + i + '_' + template.type)?.value" alt="Temperature photo {{ i + 1 }}" class="uploaded-photo-small" />
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Error Messages -->
        <div class="error-message" *ngIf="dynamicForm.get('field_' + field.id)?.invalid && dynamicForm.get('field_' + field.id)?.touched">
          <span *ngIf="dynamicForm.get('field_' + field.id)?.errors?.['required']">
            This field is required
          </span>
          <span *ngIf="dynamicForm.get('field_' + field.id)?.errors?.['min']">
            Value must be at least {{ field.validation_rules?.min }}
          </span>
          <span *ngIf="dynamicForm.get('field_' + field.id)?.errors?.['max']">
            Value must not exceed {{ field.validation_rules?.max }}
          </span>
        </div>
      </div>
    </div>

    <!-- Submit Button -->
    <div class="form-actions">
      <button
        type="submit"
        [disabled]="submitting || dynamicForm.invalid"
        class="submit-btn"
      >
        <span *ngIf="!submitting">Submit Form</span>
        <span *ngIf="submitting" class="flex items-center justify-center">
          <span class="spinner-sm mr-2"></span>
          Submitting...
        </span>
      </button>
    </div>
  </form>

  <!-- Empty State -->
  <div *ngIf="!loading && taskFields.length === 0" class="empty-state">
    <span class="text-5xl mb-4 block">üìã</span>
    <p class="text-gray-600">No form fields configured for this task</p>
  </div>
</div>
